<?php
/**
 * @file
 * workbench_moderation.test
 */

/**
 * Tests for Workbench Moderation.
 */
class WorkbenchModerationWebTestCase extends DrupalWebTestCase {
  public static function getInfo() {
    return array(
      'name' => 'Workbench Moderation basic tests',
      'description' => 'Perform basic web tests on Workbench Moderation.',
      'group' => 'Workbench Moderation',
    );
  }

  function setup() {
    parent::setup('state_machine', 'state_flow', 'state_flow_entity', 'workbench_moderation', 'workbench_workflows', 'views');

    // install the basic workflow.
    module_load_include('inc', 'workbench_workflows', 'includes/workbench_workflows.starter');
    workbench_workflows_import_starter_exportables();

    $web_user = $this->drupalCreateUser(array('administer nodes', 'bypass node access'));
    $this->drupalLogin($web_user);
  }

  /**
   * Test View Draft tab.
   */
  function testViewDraftTab() {

    // This first chunk is not specific to the draft tab and perhaps should be
    // abstracted to a helper function.

    $edit = array();
    $title = $this->randomName(8);
    $edit['title'] = $title;
    $edit['event'] = 'draft';
    $edit['event_comment'] = $this->randomName(8);
    $this->drupalPost("node/add/article", $edit, t('Save'));
    $this->drupalGet("node/1");
    $this->assertText($title, t('Title is visible on draft node for logged in user.'));

    // Check for duplicate state records.
    $this->_testOfDuplicateStates();

    // Check that view draft tab is not displaying.
    $this->drupalGet('node/1/draft');
    $this->assertResponse(403, 'View Draft tab responds with 403 to logged in user');

    // Check anonymous behavior. Verify access denied.
    $this->drupalLogout();
    $this->drupalGet("node/1");
    $this->assertNoText($title, t('Title is not visible on draft node for anonymous user.'));
    $this->assertResponse(403, 'Draft node page responds with 403 to anonymous user');

    // Check that view draft tab is not displaying.
    $this->drupalGet('node/1/draft');
    $this->assertResponse(403, 'View Draft tab responds with 403 to anonymous user');

    // Log in again.
    $web_user = $this->drupalCreateUser(array('administer nodes', 'bypass node access'));
    $this->drupalLogin($web_user);

    // Set the node to published.
    $edit =array();
    $edit['event'] = 'published';
    $edit['event_comment'] = $this->randomName(8);
    $this->drupalPost("node/1/revisions-state-flow-states", $edit, t('Update State'));
    $this->drupalGet("node/1");
    $this->assertText($title, t('Title is visible on published node for logged in user.'));

    // Check for duplicate state records.
    $this->_testOfDuplicateStates();

    // Check that view draft tab is not displaying.
    $this->drupalGet('node/1/draft');
    $this->assertResponse(403, 'View Draft tab responds with 403 to logged in user');

    // Check anonymous behavior. Verify access after publishing.
    $this->drupalLogout();
    $this->drupalGet("node/1");
    $this->assertText($title, t('After publishing, anonymous user can see node title.'));
    $this->assertResponse(200, 'After publishing,  anonymous user gets a 200 for node page.');

    // Check that view draft tab is not displaying.
    $this->drupalGet('node/1/draft');
    $this->assertResponse(403, 'View Draft tab responds with 403 to anonymous user');

    // Log in again.
    $web_user = $this->drupalCreateUser(array('administer nodes', 'bypass node access'));
    $this->drupalLogin($web_user);

    // Edit the node, creating a new title, set to needs review.
    $edit = array();
    $new_title = $this->randomName(8);
    $edit['title'] = $new_title;
    $edit['event'] = 'needs_review';
    $this->drupalPost("node/1/edit", $edit, t('Save'));

    // Check for duplicate state records.
    $this->_testOfDuplicateStates();

    // Check node/1.
    // Verify that it is still showing the old title.
    $this->drupalGet("node/1");
    $this->assertText($title, t('User can see published node title.'));
    $this->assertResponse(200, 'User gets a 200 for node page.');

    // Check node/1/draft
    // Verify that it is showing the new draft title.
    $this->drupalGet("node/1/draft");
    $this->assertText($new_title, t('User can see node draft title.'));
    $this->assertResponse(200, 'User gets a 200 for node draft page.');

    // Log out.
    // Check node/1.
    // Verify that it is still showing the old title to anonymous users.
    $this->drupalLogout();
    $this->drupalGet("node/1");
    $this->assertText($title, t('Title is visible on published node for anonymous user.'));
    $this->assertResponse(200, 'Anonymous user gets a 200 for node page.');

    // Check node/1/draft
    // Verify that gives an access denied.
    $this->drupalGet("node/1/draft");
    $this->assertNoText($new_title, t('Title is not visible on draft node for anonymous user.'));
    $this->assertResponse(403, 'Draft node page responds with 403 to anonymous user');
  }

  /**
   * Helper function to check for duplicate state records.
   */
  function _testOfDuplicateStates() {

    $states = db_select('state_flow_states')
                ->fields('state_flow_states', array())
                ->execute()
                ->fetchAll();

    $hids = array();
    $duplicates = FALSE;
    foreach ($states as $state) {
      if (!empty($state->hid)) {
        if (empty($hids[$state->hid])) {
          $hids[$state->hid][] = $state;
        }
        else {
          $duplicates = TRUE;
        }
      }
    }

    $this->assertFalse($duplicates, t('There are no duplicate records in State Flow States'));

    if ($duplicates) {
      debug($states);
    }
  }
}
